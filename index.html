<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="apple-mobile-web-app-title" content="Invoice App">
<meta name="mobile-web-app-capable" content="yes">
<meta name="theme-color" content="#007ACC">
    <title>HVAC Invoice Generator</title>
    <link rel="stylesheet" href="style.css">
    <link rel="manifest" href="manifest.json">
</head>
<body>
    <div class="container">
        <header>
            <h1>‚ùÑÔ∏è Corcho Invoice Generator</h1>
            <nav class="main-nav">
                <button class="nav-btn active" onclick="showSection('invoice')">New Invoice</button>
                <button class="nav-btn" onclick="showSection('customers')">Customers</button>
                <button class="nav-btn" onclick="showSection('workLocations')">Work Locations</button>
                <button class="nav-btn" onclick="showSection('history')">History</button>
                <button class="nav-btn" onclick="showSection('settings')">Settings</button>
            </nav>
        </header>

        <!-- INVOICE SECTION -->
        <section id="invoice" class="section active">
            <div class="section-header">
                <h2>Create New Invoice</h2>
            </div>
            
            <!-- Customer Information -->
            <div class="card">
                <h3>Customer Information</h3>
                <div class="form-row">
                    <select id="customerSelect" class="input" onchange="loadCustomerData()">
                        <option value="">Select customer...</option>
                    </select>
                    <button onclick="showSection('customers')" class="btn secondary">Manage Customers</button>
                </div>
                <div class="form-row">
                    <input type="text" id="customerName" placeholder="Customer Name" class="input">
                    <input type="text" id="customerAddress" placeholder="Address" class="input">
                </div>
                <div class="form-row">
                    <input type="email" id="customerEmail" placeholder="Email" class="input">
                    <input type="text" id="customerPhone" placeholder="Phone" class="input">
                </div>
            </div>

            <!-- Work Location -->
            <div class="card">
                <h3>Work Location</h3>
                <div class="form-row">
                    <select id="workLocationSelect" class="input" onchange="loadWorkLocationData()">
                        <option value="">Select work location...</option>
                        <option value="new">+ Add New Location</option>
                    </select>
                </div>
                <div class="form-row">
                    <input type="text" id="workLocationName" placeholder="Location Name" class="input">
                    <input type="text" id="workLocationAddress" placeholder="Address" class="input">
                </div>
                <div class="form-row">
                    <input type="text" id="workLocationCity" placeholder="City" class="input">
                    <input type="text" id="workLocationState" placeholder="State" class="input">
                    <input type="text" id="workLocationZip" placeholder="Zip Code" class="input">
                </div>
            </div>

            <!-- Invoice Details -->
            <div class="card">
                <h3>Invoice Details</h3>
                <div class="form-row">
                    <input type="text" id="invoiceNumber" placeholder="Invoice Number" class="input">
                    <input type="date" id="invoiceDate" class="input">
                </div>
                <div class="form-row">
                    <textarea id="invoiceObservations" placeholder="Observations (optional - will appear below column headers in PDF)" class="input textarea" rows="2"></textarea>
                </div>
            </div>

            <!-- Items -->
            <div class="card">
                <h3>Invoice Items</h3>
                <div class="item-form">
                    <textarea id="itemDescription" placeholder="Item Description (supports multiple lines)" class="input textarea" rows="3"></textarea>
                    <input type="number" id="itemQuantity" placeholder="Qty" class="input small" min="1" value="1">
                    <input type="number" id="itemPrice" placeholder="Unit Price" step="0.01" class="input small">
                    <button onclick="addItem()" class="btn">Add Item</button>
                </div>
                
                <div id="itemsList" class="items-list"></div>
                
                <div class="summary">
                    <div class="summary-row">
                        <span>Subtotal:</span>
                        <span>$<span id="subtotal">0.00</span></span>
                    </div>
                    <div class="summary-row">
                        <span>Tax (%):</span>
                        <div>
                            <input type="number" id="taxRate" value="0" min="0" max="100" step="0.1" class="input tiny" onchange="calculateTotal()">%
                        </div>
                    </div>
                    <div class="summary-row">
                        <span>Tax Amount:</span>
                        <span>$<span id="taxAmount">0.00</span></span>
                    </div>
                    <div class="summary-row total">
                        <strong>Total:</strong>
                        <strong>$<span id="totalAmount">0.00</span></strong>
                    </div>
                </div>
            </div>

            <!-- Actions -->
            <div class="actions">
                <button onclick="clearInvoice()" class="btn secondary">Clear All</button>
                <button onclick="saveDraft()" class="btn">Save Draft</button>
                <button onclick="generatePDF()" class="btn primary">Generate PDF</button>
                <button onclick="shareInvoice()" class="btn success" id="shareBtn" style="display: none;">Share Invoice</button>
            </div>
        </section>

        <!-- CUSTOMERS SECTION -->
        <section id="customers" class="section">
            <div class="section-header">
                <h2>Customer Management</h2>
                <button onclick="showNewCustomerForm()" class="btn primary">Add New Customer</button>
            </div>

            <!-- Customer Form -->
            <div class="card" id="customerForm" style="display: none;">
                <h3 id="customerFormTitle">Add New Customer</h3>
                <div class="form-row">
                    <input type="text" id="newCustomerName" placeholder="Customer Name" class="input">
                    <input type="text" id="newCustomerPhone" placeholder="Phone" class="input">
                </div>
                <div class="form-row">
                    <input type="email" id="newCustomerEmail" placeholder="Email" class="input">
                    <input type="text" id="newCustomerAddress" placeholder="Address" class="input">
                </div>
                <div class="form-actions">
                    <button onclick="hideCustomerForm()" class="btn secondary">Cancel</button>
                    <button onclick="saveCustomer()" class="btn primary">Save Customer</button>
                </div>
            </div>

            <!-- Customers List -->
            <div class="card">
                <h3>Saved Customers</h3>
                <div id="customersList" class="customers-list"></div>
            </div>
        </section>

        <!-- WORK LOCATIONS SECTION -->
        <section id="workLocations" class="section">
            <div class="section-header">
                <h2>Work Locations Management</h2>
                <button onclick="showNewWorkLocationForm()" class="btn primary">Add New Location</button>
            </div>

            <!-- Work Location Form -->
            <div class="card" id="workLocationForm" style="display: none;">
                <h3 id="workLocationFormTitle">Add New Work Location</h3>
                <div class="form-row">
                    <input type="text" id="newLocationName" placeholder="Location Name" class="input">
                    <input type="text" id="newLocationAddress" placeholder="Address" class="input">
                </div>
                <div class="form-row">
                    <input type="text" id="newLocationCity" placeholder="City" class="input">
                    <input type="text" id="newLocationState" placeholder="State" class="input">
                    <input type="text" id="newLocationZip" placeholder="Zip Code" class="input">
                </div>
                <div class="form-actions">
                    <button onclick="hideWorkLocationForm()" class="btn secondary">Cancel</button>
                    <button onclick="saveWorkLocation()" class="btn primary">Save Location</button>
                </div>
            </div>

            <!-- Work Locations List -->
            <div class="card">
                <h3>Saved Work Locations</h3>
                <div id="workLocationsList" class="customers-list"></div>
            </div>
        </section>

       <!-- HISTORY SECTION -->
<section id="history" class="section">
    <div class="section-header">
        <h2>Invoice History</h2>
        <div>
            <button onclick="exportData()" class="btn secondary">Export Data</button>
            <input type="file" id="importFile" accept=".json" onchange="importData(event)" style="display: none;">
            <button onclick="document.getElementById('importFile').click()" class="btn secondary">Import Data</button>
        </div>
    </div>

    <div class="card">
        <div class="history-filters">
            <input type="text" id="searchHistory" placeholder="Search invoices..." class="input" onkeyup="filterHistory()">
            <select id="customerFilter" class="input" onchange="filterHistory()">
                <option value="">All Customers</option>
            </select>
        </div>
        
        <div id="historyList" class="history-list"></div>
    </div>
</section>

        <!-- SETTINGS SECTION -->
        <section id="settings" class="section">
            <div class="section-header">
                <h2>Settings</h2>
            </div>
<div class="card">
    <h3>App Installation</h3>
    <p>Install this app on your device for quick access:</p>
    <button onclick="installPWA()" class="btn success" id="installBtn" style="display: none;">
        üì± Install App
    </button>
    <p id="pwaStatus">Checking PWA status...</p>
    <div id="pwaDebug" style="margin-top: 10px; padding: 10px; background: #f0f0f0; border-radius: 5px; font-size: 12px; display: none;">
        <strong>Debug Info:</strong>
        <ul id="pwaDebugList"></ul>
    </div>
    <button onclick="togglePwaDebug()" class="btn secondary" style="margin-top: 10px;">Show Debug Info</button>
</div>
            <div class="card">
                <h3>Business Information</h3>
                <div class="form-row">
                    <input type="text" id="businessName" placeholder="Your Business Name" class="input">
                    <input type="text" id="businessSlogan" placeholder="Business Slogan" class="input">
                </div>
                <div class="form-row">
                    <input type="text" id="businessAddress" placeholder="Business Address" class="input">
                    <input type="text" id="businessPhone" placeholder="Business Phone" class="input">
                </div>
                <div class="form-row">
                    <input type="email" id="businessEmail" placeholder="Business Email" class="input">
                    <input type="text" id="businessTaxId" placeholder="Tax ID" class="input">
                </div>
                <button onclick="saveBusinessInfo()" class="btn primary">Save Business Info</button>
            </div>

            <div class="card">
                <h3>Data Management</h3>
                <div class="settings-actions">
                    <button onclick="exportData()" class="btn secondary">Export All Data</button>
                    <button onclick="document.getElementById('importFile').click()" class="btn secondary">Import Data</button>
                    <button onclick="clearAllData()" class="btn danger">Clear All Data</button>
                </div>
                <div class="data-stats">
                    <p>Customers: <span id="customersCount">0</span></p>
                    <p>Work Locations: <span id="locationsCount">0</span></p>
                    <p>Invoices: <span id="invoicesCount">0</span></p>
                    <p>Storage Used: <span id="storageUsed">0 KB</span></p>
                </div>
            </div>

            <div class="card">
                <h3>Invoice Settings</h3>
                <div class="form-row">
                    <label>
                        Default Tax Rate (%):
                        <input type="number" id="defaultTaxRate" value="0" min="0" max="100" step="0.1" class="input tiny">
                    </label>
                    <label>
                        Invoice Prefix:
                        <input type="text" id="invoicePrefix" value="INV-" class="input tiny">
                    </label>
                </div>
                <button onclick="saveInvoiceSettings()" class="btn primary">Save Settings</button>
            </div>
        </section>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="script.js"></script>
<script>
    // PWA Debug info
    const pwaDebugInfo = [];
    let swRegistered = false;
    let manifestLoaded = false;
    
    function addDebugInfo(message, isError = false) {
        pwaDebugInfo.push({ message, isError });
        console.log(isError ? '‚ùå' : '‚úÖ', message);
    }
    
    function updateDebugDisplay() {
        const list = document.getElementById('pwaDebugList');
        if (list) {
            list.innerHTML = pwaDebugInfo.map(info => 
                `<li style="color: ${info.isError ? 'red' : 'green'}">${info.isError ? '‚ùå' : '‚úÖ'} ${info.message}</li>`
            ).join('');
        }
    }
    
    function togglePwaDebug() {
        const debug = document.getElementById('pwaDebug');
        debug.style.display = debug.style.display === 'none' ? 'block' : 'none';
        updateDebugDisplay();
    }
    
    function updatePwaStatus() {
        const status = document.getElementById('pwaStatus');
        const installBtn = document.getElementById('installBtn');
        
        // Check protocol
        const isSecure = location.protocol === 'https:' || location.hostname === 'localhost' || location.hostname === '127.0.0.1';
        const isFileProtocol = location.protocol === 'file:';
        
        if (isFileProtocol) {
            status.innerHTML = '‚ö†Ô∏è <strong>Cannot install from local file.</strong><br>PWAs require HTTPS. Please:<br>1. Upload to GitHub Pages, or<br>2. Use a local server (see instructions below)';
            status.style.color = '#856404';
            status.style.background = '#fff3cd';
            status.style.padding = '10px';
            status.style.borderRadius = '5px';
            addDebugInfo('Running from file:// protocol - PWA not supported', true);
        } else if (!isSecure) {
            status.innerHTML = '‚ö†Ô∏è <strong>HTTPS required.</strong><br>PWAs only work on HTTPS or localhost.';
            status.style.color = 'red';
            addDebugInfo('Not running on HTTPS or localhost', true);
        } else if (deferredPrompt) {
            status.innerHTML = '‚úÖ <strong>Ready to install!</strong> Click the button above.';
            status.style.color = 'green';
            installBtn.style.display = 'inline-block';
        } else if (window.matchMedia('(display-mode: standalone)').matches) {
            status.innerHTML = '‚úÖ <strong>Already installed!</strong> Running as PWA.';
            status.style.color = 'green';
        } else if (swRegistered) {
            status.innerHTML = '‚è≥ <strong>Service Worker ready.</strong> Waiting for browser install prompt...<br><small>Try refreshing the page or check if already installed.</small>';
            status.style.color = '#0056b3';
        } else {
            status.innerHTML = '‚è≥ Loading...';
        }
    }

    // Check manifest
    fetch('./manifest.json')
        .then(response => {
            if (response.ok) {
                addDebugInfo('Manifest loaded successfully');
                manifestLoaded = true;
                return response.json();
            } else {
                throw new Error('Manifest not found');
            }
        })
        .then(manifest => {
            addDebugInfo(`App name: ${manifest.name}`);
            addDebugInfo(`Icons defined: ${manifest.icons?.length || 0}`);
        })
        .catch(error => {
            addDebugInfo('Manifest error: ' + error.message, true);
        });

    // Register Service Worker for PWA
    if ('serviceWorker' in navigator) {
        addDebugInfo('Service Worker supported');
        
        window.addEventListener('load', function() {
            navigator.serviceWorker.register('./sw.js')
                .then(function(registration) {
                    console.log('ServiceWorker registration successful with scope: ', registration.scope);
                    addDebugInfo('Service Worker registered');
                    swRegistered = true;
                    updatePwaStatus();
                })
                .catch(function(error) {
                    console.log('ServiceWorker registration failed: ', error);
                    addDebugInfo('Service Worker failed: ' + error.message, true);
                    updatePwaStatus();
                });
        });
    } else {
        addDebugInfo('Service Worker not supported in this browser', true);
    }

    // Show install prompt for PWA
    let deferredPrompt;
    const installButton = document.createElement('button');
    
    window.addEventListener('beforeinstallprompt', (e) => {
        // Prevent the mini-infobar from appearing on mobile
        e.preventDefault();
        // Stash the event so it can be triggered later
        deferredPrompt = e;
        addDebugInfo('Install prompt available!');
        
        // Create and show floating install button
        installButton.textContent = 'üì± Install App';
        installButton.className = 'btn success';
        installButton.style.position = 'fixed';
        installButton.style.bottom = '20px';
        installButton.style.right = '20px';
        installButton.style.zIndex = '1000';
        installButton.onclick = installPWA;
        
        document.body.appendChild(installButton);
        
        // Update status in settings
        updatePwaStatus();
    });

    function installPWA() {
        if (deferredPrompt) {
            // Show the install prompt
            deferredPrompt.prompt();
            // Wait for the user to respond to the prompt
            deferredPrompt.userChoice.then((choiceResult) => {
                if (choiceResult.outcome === 'accepted') {
                    console.log('User accepted the install prompt');
                    addDebugInfo('User accepted installation');
                } else {
                    console.log('User dismissed the install prompt');
                    addDebugInfo('User dismissed installation');
                }
                deferredPrompt = null;
                // Remove the install button
                installButton.remove();
                updatePwaStatus();
            });
        } else {
            alert('Installation not available. Make sure you are:\n1. Using HTTPS (like GitHub Pages)\n2. Using a supported browser (Chrome, Edge, etc.)');
        }
    }

    // Detect if the app is launched as PWA
    window.addEventListener('appinstalled', (evt) => {
        console.log('App was installed as PWA');
        addDebugInfo('App was installed!');
        installButton.remove();
        updatePwaStatus();
    });

    // Check if running as PWA
    if (window.matchMedia('(display-mode: standalone)').matches) {
        console.log('Running as PWA');
        addDebugInfo('Running in standalone mode (PWA)');
    }
    
    // Initial status check
    setTimeout(updatePwaStatus, 1000);
</script>
</body>
</html>